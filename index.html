<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#5A1A22">
<title>Bestattungshaus Kallwa√ü ‚Äì Beratung</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400&family=Nunito+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bordeaux:#5A1A22;--bordeaux-light:#722F37;--bordeaux-dark:#3E0F15;
  --gold:#C5A55A;--gold-light:#D4BA7A;--gold-dark:#A8893E;
  --cream:#FAF7F2;--warm-white:#FEFCF9;--warm-gray:#E8E2DA;
  --text-dark:#2A1A1D;--text-muted:#6B5A5E;--text-light:#9A8A8E;
  --shadow-sm:0 1px 3px rgba(90,26,34,0.08);--shadow-md:0 4px 16px rgba(90,26,34,0.1);
  --shadow-lg:0 8px 32px rgba(90,26,34,0.14);--shadow-xl:0 16px 48px rgba(90,26,34,0.18);
  --radius:12px;--radius-lg:20px;
  --transition:0.3s cubic-bezier(0.4,0,0.2,1);
  --font-display:'Cormorant Garamond',Georgia,serif;
  --font-body:'Nunito Sans',system-ui,sans-serif;
}
html{font-size:16px;-webkit-text-size-adjust:100%;scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--cream);color:var(--text-dark);line-height:1.6;min-height:100vh;min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
#loading-screen{position:fixed;inset:0;z-index:9999;background:var(--bordeaux);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.6s ease,visibility 0.6s ease}
#loading-screen.hidden{opacity:0;visibility:hidden;pointer-events:none}
#loading-screen .logo-text{font-family:var(--font-display);font-size:2rem;color:var(--gold);letter-spacing:0.08em;font-weight:300;margin-bottom:1.5rem}
.loader{width:40px;height:40px;border:2px solid rgba(197,165,90,0.2);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
header{position:sticky;top:0;z-index:100;background:rgba(90,26,34,0.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(197,165,90,0.2)}
.header-inner{max-width:1200px;margin:0 auto;padding:0.9rem 1.5rem;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:0.75rem;text-decoration:none;cursor:pointer}
.brand-icon{width:38px;height:38px;border:1.5px solid var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--gold);font-family:var(--font-display);font-size:1.1rem;font-weight:600}
.brand-name{font-family:var(--font-display);font-size:1.25rem;font-weight:400;color:var(--cream);letter-spacing:0.06em}
.brand-name span{color:var(--gold)}
.nav-buttons{display:flex;align-items:center;gap:0.25rem}
.nav-btn{background:none;border:none;cursor:pointer;color:var(--cream);font-family:var(--font-body);font-size:0.82rem;padding:0.5rem 0.9rem;border-radius:8px;transition:var(--transition);font-weight:500;letter-spacing:0.02em;opacity:0.85;white-space:nowrap;-webkit-tap-highlight-color:transparent}
.nav-btn:hover,.nav-btn.active{opacity:1;background:rgba(197,165,90,0.15)}
.nav-btn.active{color:var(--gold)}
.nav-btn.admin-btn{background:rgba(197,165,90,0.12);border:1px solid rgba(197,165,90,0.3);color:var(--gold);opacity:1}
.nav-btn.admin-btn:hover{background:rgba(197,165,90,0.22)}
.hamburger{display:none;background:none;border:none;cursor:pointer;padding:0.5rem;color:var(--cream);-webkit-tap-highlight-color:transparent}
.mobile-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:199;opacity:0;visibility:hidden;transition:var(--transition)}
.mobile-overlay.active{opacity:1;visibility:visible}
.mobile-drawer{position:fixed;top:0;right:-300px;width:280px;height:100%;background:var(--bordeaux-dark);z-index:200;padding:1.5rem;transition:right 0.35s cubic-bezier(0.4,0,0.2,1);box-shadow:-4px 0 24px rgba(0,0,0,0.3);display:flex;flex-direction:column}
.mobile-drawer.open{right:0}
.drawer-close{align-self:flex-end;background:none;border:none;color:var(--cream);font-size:1.5rem;cursor:pointer;padding:0.5rem;margin-bottom:1.5rem}
.drawer-nav{display:flex;flex-direction:column;gap:0.5rem}
.drawer-nav .nav-btn{text-align:left;padding:0.9rem 1rem;font-size:0.95rem;border-radius:10px;display:block;width:100%}
@media(max-width:768px){.hamburger{display:flex;align-items:center}.nav-buttons{display:none}}
@media(min-width:769px){.mobile-drawer,.mobile-overlay{display:none!important}}
main{max-width:1200px;margin:0 auto;padding:1.5rem}
.page{display:none;animation:fadeUp 0.4s ease}.page.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.hero{text-align:center;padding:3rem 1.5rem 2.5rem;background:linear-gradient(180deg,rgba(90,26,34,0.04) 0%,transparent 100%);border-radius:var(--radius-lg);margin-bottom:2rem}
.hero h1{font-family:var(--font-display);font-size:clamp(1.8rem,4vw,2.8rem);font-weight:300;color:var(--bordeaux);line-height:1.25;margin-bottom:0.75rem;letter-spacing:0.02em}
.hero h1 em{font-style:italic;color:var(--gold-dark);font-weight:400}
.hero p{font-size:clamp(0.9rem,1.5vw,1.05rem);color:var(--text-muted);max-width:520px;margin:0 auto;font-weight:300;line-height:1.7}
.gold-line{width:48px;height:2px;background:var(--gold);margin:1.25rem auto;border-radius:1px}
.categories-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.25rem;margin-bottom:2rem}
.cat-card{background:var(--warm-white);border-radius:var(--radius-lg);overflow:hidden;cursor:pointer;border:1px solid rgba(90,26,34,0.06);transition:var(--transition);position:relative}
.cat-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg)}
.cat-card-img{width:100%;height:180px;object-fit:cover;background:linear-gradient(135deg,var(--bordeaux) 0%,var(--bordeaux-light) 100%);display:flex;align-items:center;justify-content:center;color:var(--gold);font-size:2.5rem}
.cat-card-img img{width:100%;height:100%;object-fit:cover}
.cat-card-body{padding:1.25rem}
.cat-card-body h3{font-family:var(--font-display);font-size:1.3rem;font-weight:500;color:var(--bordeaux);margin-bottom:0.3rem}
.cat-card-body p{font-size:0.85rem;color:var(--text-muted);font-weight:300}
.cat-card-count{position:absolute;top:1rem;right:1rem;background:rgba(90,26,34,0.85);color:var(--gold);font-size:0.75rem;padding:0.25rem 0.65rem;border-radius:20px;font-weight:600;backdrop-filter:blur(8px)}

/* Subcategory selection on products page */
.subcategory-bar{display:none;gap:0.5rem;margin-bottom:1.5rem;flex-wrap:wrap;padding-bottom:0.5rem}
.subcategory-bar.visible{display:flex}
.subcat-pill{padding:0.5rem 1.2rem;border-radius:24px;border:1.5px solid var(--warm-gray);background:var(--warm-white);font-family:var(--font-body);font-size:0.84rem;font-weight:500;cursor:pointer;transition:var(--transition);color:var(--text-muted);-webkit-tap-highlight-color:transparent;box-shadow:var(--shadow-sm)}
.subcat-pill:hover{border-color:var(--bordeaux);color:var(--bordeaux);box-shadow:var(--shadow-md)}
.subcat-pill.active{background:var(--bordeaux);color:var(--cream);border-color:var(--bordeaux);box-shadow:var(--shadow-md)}
.subcat-pill.all-pill{font-weight:600;font-size:0.78rem;letter-spacing:0.03em;text-transform:uppercase}

.products-header{display:flex;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}
.back-btn{background:none;border:1px solid var(--warm-gray);color:var(--text-dark);padding:0.5rem 1rem;border-radius:8px;cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:var(--transition);display:flex;align-items:center;gap:0.4rem;-webkit-tap-highlight-color:transparent}
.back-btn:hover{border-color:var(--bordeaux);color:var(--bordeaux)}
.products-header h2{font-family:var(--font-display);font-size:1.8rem;font-weight:400;color:var(--bordeaux)}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1.25rem}
.product-card{background:var(--warm-white);border-radius:var(--radius);overflow:hidden;border:1px solid rgba(90,26,34,0.06);transition:var(--transition);cursor:pointer}
.product-card:hover{box-shadow:var(--shadow-md)}
.product-card-img{width:100%;height:260px;object-fit:cover;background:#f5f0ea;display:flex;align-items:center;justify-content:center}
.product-card-img img{width:100%;height:100%;object-fit:contain;padding:12px}
.product-card-body{padding:1.15rem}
.product-card-body h4{font-family:var(--font-display);font-size:1.15rem;font-weight:500;color:var(--bordeaux);margin-bottom:0.35rem}
.product-card-body .price{font-size:1rem;color:var(--gold-dark);font-weight:600;margin-bottom:0.4rem}
.product-card-body .desc{font-size:0.82rem;color:var(--text-muted);line-height:1.55;font-weight:300}
.product-card-body .subcat-tag{display:inline-block;font-size:0.72rem;color:var(--text-light);background:rgba(90,26,34,0.05);padding:0.15rem 0.5rem;border-radius:6px;margin-top:0.4rem}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:500;display:none;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px)}
.modal-overlay.active{display:flex}
.modal{background:var(--warm-white);border-radius:var(--radius-lg);max-width:600px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-xl);animation:modalIn 0.3s ease;position:relative}
@keyframes modalIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
.modal-img{width:100%;height:350px;object-fit:cover;background:#f5f0ea;display:flex;align-items:center;justify-content:center}
.modal-img img{width:100%;height:100%;object-fit:contain;padding:16px}
.modal-body{padding:1.75rem}
.modal-body h2{font-family:var(--font-display);font-size:1.6rem;font-weight:500;color:var(--bordeaux);margin-bottom:0.5rem}
.modal-body .price{font-size:1.2rem;color:var(--gold-dark);font-weight:600;margin-bottom:1rem}
.modal-body .desc{font-size:0.92rem;color:var(--text-muted);line-height:1.7;font-weight:300;white-space:pre-line}
.modal-close{position:absolute;top:1rem;right:1rem;width:36px;height:36px;border-radius:50%;border:none;background:rgba(0,0,0,0.5);color:#fff;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);z-index:10}
.modal-close:hover{background:rgba(0,0,0,0.7)}

/* Edit Modal */
.edit-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:600;display:none;align-items:flex-start;justify-content:center;padding:2rem 1rem;backdrop-filter:blur(4px);overflow-y:auto}
.edit-modal-overlay.active{display:flex}
.edit-modal{background:var(--warm-white);border-radius:var(--radius-lg);max-width:520px;width:100%;box-shadow:var(--shadow-xl);animation:modalIn 0.3s ease;position:relative;margin:auto}
.edit-modal-header{padding:1.5rem 1.5rem 0;display:flex;align-items:center;justify-content:space-between}
.edit-modal-header h3{font-family:var(--font-display);font-size:1.4rem;font-weight:500;color:var(--bordeaux)}
.edit-modal-body{padding:1.5rem}

/* Forms */
.login-card{max-width:400px;margin:3rem auto;background:var(--warm-white);padding:2.5rem;border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);border:1px solid rgba(90,26,34,0.08)}
.login-card h2{font-family:var(--font-display);font-size:1.6rem;font-weight:400;color:var(--bordeaux);text-align:center;margin-bottom:0.5rem}
.login-card .subtitle{text-align:center;color:var(--text-muted);font-size:0.85rem;margin-bottom:2rem;font-weight:300}
.form-group{margin-bottom:1.25rem}
.form-group label{display:block;font-size:0.8rem;font-weight:600;color:var(--text-muted);margin-bottom:0.4rem;text-transform:uppercase;letter-spacing:0.08em}
.form-group input,.form-group textarea,.form-group select{width:100%;padding:0.75rem 1rem;border:1.5px solid var(--warm-gray);border-radius:10px;font-family:var(--font-body);font-size:0.92rem;background:var(--cream);color:var(--text-dark);transition:var(--transition)}
.form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(197,165,90,0.15)}
.form-group textarea{resize:vertical;min-height:80px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem 1.5rem;border-radius:10px;border:none;font-family:var(--font-body);font-size:0.9rem;font-weight:600;cursor:pointer;transition:var(--transition);letter-spacing:0.02em;-webkit-tap-highlight-color:transparent}
.btn-primary{background:var(--bordeaux);color:var(--cream);width:100%}.btn-primary:hover{background:var(--bordeaux-light)}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bordeaux-dark)}.btn-gold:hover{box-shadow:var(--shadow-md)}
.btn-outline{background:transparent;border:1.5px solid var(--warm-gray);color:var(--text-dark)}.btn-outline:hover{border-color:var(--bordeaux);color:var(--bordeaux)}
.btn-sm{padding:0.5rem 1rem;font-size:0.82rem}
.btn-row{display:flex;gap:0.75rem;margin-top:1.25rem}
.btn-row .btn{flex:1}

/* Admin */
.admin-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:2rem}
.admin-header h2{font-family:var(--font-display);font-size:1.8rem;font-weight:400;color:var(--bordeaux)}
.admin-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-bottom:2rem}
.stat-card{background:var(--warm-white);padding:1.25rem;border-radius:var(--radius);border:1px solid rgba(90,26,34,0.06);text-align:center}
.stat-card .num{font-family:var(--font-display);font-size:2rem;font-weight:600;color:var(--bordeaux)}
.stat-card .label{font-size:0.78rem;color:var(--text-muted);margin-top:0.2rem;font-weight:500}
.admin-section{background:var(--warm-white);border-radius:var(--radius-lg);padding:1.5rem;margin-bottom:1.5rem;border:1px solid rgba(90,26,34,0.06)}
.admin-section h3{font-family:var(--font-display);font-size:1.3rem;font-weight:500;color:var(--bordeaux);margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid var(--warm-gray)}
.admin-list{list-style:none}
.admin-list>li{padding:0.75rem 0;border-bottom:1px solid rgba(0,0,0,0.04)}
.admin-list>li:last-child{border-bottom:none}
.cat-row{display:flex;align-items:center;justify-content:space-between;width:100%;gap:0.5rem;flex-wrap:wrap}
.item-info{display:flex;align-items:center;gap:0.75rem;flex:1;min-width:0}
.item-thumb{width:48px;height:48px;border-radius:8px;object-fit:cover;background:var(--warm-gray);flex-shrink:0}
.item-name{font-weight:500;font-size:0.92rem;overflow:hidden;text-overflow:ellipsis}
.item-actions{display:flex;gap:0.35rem;flex-shrink:0;flex-wrap:wrap}
.item-actions button{background:none;border:1px solid var(--warm-gray);width:32px;height:32px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:0.85rem;transition:var(--transition)}
.item-actions button:hover{border-color:var(--bordeaux);color:var(--bordeaux)}
.item-actions button.del:hover{border-color:#c0392b;color:#c0392b}
.item-actions button[disabled]{opacity:0.3;cursor:default;pointer-events:none}

/* Subcategory admin */
.subcat-list{margin-top:0.5rem;padding-left:1.5rem;list-style:none}
.subcat-list li{padding:0.35rem 0;font-size:0.88rem;display:flex;align-items:center;gap:0.3rem}
.subcat-inline{display:flex;gap:0.5rem;align-items:center;margin-top:0.5rem;padding-left:1.5rem}
.subcat-inline input{flex:1;padding:0.4rem 0.7rem;border:1.5px solid var(--warm-gray);border-radius:8px;font-family:var(--font-body);font-size:0.85rem;background:var(--cream)}
.subcat-inline input:focus{outline:none;border-color:var(--gold)}
.subcat-inline button{padding:0.4rem 0.8rem;border-radius:8px;border:none;background:var(--bordeaux);color:var(--cream);font-size:0.8rem;cursor:pointer;font-weight:600;white-space:nowrap}

/* File Upload */
.file-upload{border:2px dashed var(--warm-gray);border-radius:var(--radius);padding:2rem;text-align:center;cursor:pointer;transition:var(--transition);position:relative}
.file-upload:hover{border-color:var(--gold);background:rgba(197,165,90,0.04)}
.file-upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
.file-upload .icon{font-size:2rem;margin-bottom:0.5rem}
.file-upload p{font-size:0.85rem;color:var(--text-muted)}
.preview-img{max-width:200px;max-height:150px;border-radius:8px;margin-top:1rem;object-fit:cover}
.current-img{max-width:120px;border-radius:8px;margin-bottom:0.75rem;border:1px solid var(--warm-gray)}

/* Toast */
.toast{position:fixed;bottom:2rem;right:2rem;z-index:9000;background:var(--bordeaux);color:var(--cream);padding:0.85rem 1.5rem;border-radius:10px;font-size:0.88rem;font-weight:500;box-shadow:var(--shadow-lg);transform:translateY(100px);opacity:0;transition:all 0.35s cubic-bezier(0.4,0,0.2,1)}
.toast.show{transform:translateY(0);opacity:1}.toast.success{background:#27ae60}.toast.error{background:#c0392b}
.empty-state{text-align:center;padding:3rem 1.5rem;color:var(--text-muted)}
.empty-state .icon{font-size:3rem;margin-bottom:1rem;opacity:0.4}
.empty-state p{font-size:0.95rem;font-weight:300}
.toggle-row{display:flex;align-items:center;gap:0.75rem;margin:1rem 0}
.toggle-row label{font-size:0.88rem;color:var(--text-dark);cursor:pointer}
.toggle{position:relative;width:44px;height:24px}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;inset:0;background:var(--warm-gray);border-radius:12px;cursor:pointer;transition:var(--transition)}
.toggle .slider::before{content:'';position:absolute;left:3px;top:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:var(--transition);box-shadow:var(--shadow-sm)}
.toggle input:checked + .slider{background:var(--bordeaux)}
.toggle input:checked + .slider::before{transform:translateX(20px)}
.admin-tabs{display:flex;gap:0.5rem;margin-bottom:1.5rem;flex-wrap:wrap}
.admin-tabs button{padding:0.6rem 1.2rem;border-radius:10px;border:1.5px solid var(--warm-gray);background:transparent;font-family:var(--font-body);font-size:0.85rem;font-weight:500;cursor:pointer;transition:var(--transition);color:var(--text-muted)}
.admin-tabs button.active{background:var(--bordeaux);color:var(--cream);border-color:var(--bordeaux)}
.admin-tabs button:hover:not(.active){border-color:var(--bordeaux);color:var(--bordeaux)}
.admin-tab-content{display:none}.admin-tab-content.active{display:block;animation:fadeUp 0.3s ease}
footer{text-align:center;padding:2rem 1.5rem;border-top:1px solid rgba(90,26,34,0.06);margin-top:3rem}
footer p{font-size:0.78rem;color:var(--text-light);font-weight:300}
footer a{color:var(--gold-dark);text-decoration:none}footer a:hover{text-decoration:underline}
@media(max-width:640px){main{padding:1rem}.hero{padding:2rem 1rem 1.5rem}.categories-grid,.products-grid{grid-template-columns:1fr}.modal{margin:0.5rem;max-height:95vh}.modal-img{height:200px}.login-card{margin:1.5rem;padding:1.75rem}.admin-section{padding:1rem}.toast{left:1rem;right:1rem;bottom:1rem;text-align:center}.edit-modal-overlay{padding:1rem}.edit-modal{max-width:100%}}
@media(min-width:769px) and (max-width:1024px){.categories-grid{grid-template-columns:repeat(2,1fr)}.products-grid{grid-template-columns:repeat(2,1fr)}}
/* Zoom Viewer */
.zoom-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:700;display:none;flex-direction:column;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent}
.zoom-overlay.active{display:flex}
.zoom-close{position:absolute;top:1rem;right:1rem;width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,255,255,0.15);color:#fff;font-size:1.3rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:710;transition:var(--transition)}
.zoom-close:hover{background:rgba(255,255,255,0.3)}
.zoom-hint{position:absolute;bottom:1.5rem;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.5);font-size:0.78rem;font-weight:400;pointer-events:none;transition:opacity 0.5s ease}
.zoom-container{width:100%;height:100%;overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:zoom-in;touch-action:none}
.zoom-container.zoomed{cursor:zoom-out}
.zoom-container img{max-width:90%;max-height:85vh;object-fit:contain;transition:transform 0.3s ease;transform-origin:center center;user-select:none;-webkit-user-select:none;pointer-events:none}
</style>
</head>
<body>
<div id="loading-screen"><div class="logo-text">Bestattungshaus Kallwa√ü</div><div class="loader"></div></div>
<div id="toast" class="toast"></div>
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileNav()"></div>
<div class="mobile-drawer" id="mobileDrawer">
  <button class="drawer-close" onclick="closeMobileNav()">‚úï</button>
  <div class="drawer-nav">
    <button class="nav-btn active" data-page="catalog" onclick="navTo('catalog')">Katalog</button>
    <button class="nav-btn" data-page="about" onclick="navTo('about')">√úber uns</button>
    <button class="nav-btn admin-btn" data-page="admin" onclick="navTo('admin')" id="adminNavBtnMobile">Verwaltung</button>
  </div>
</div>
<header>
  <div class="header-inner">
    <div class="brand" onclick="navTo('catalog')">
      <div class="brand-icon">K</div>
      <div class="brand-name">Bestattungshaus <span>Kallwa√ü</span></div>
    </div>
    <div class="nav-buttons">
      <button class="nav-btn active" data-page="catalog" onclick="navTo('catalog')">Katalog</button>
      <button class="nav-btn" data-page="about" onclick="navTo('about')">√úber uns</button>
      <button class="nav-btn admin-btn" data-page="admin" onclick="navTo('admin')" id="adminNavBtn">Verwaltung</button>
    </div>
    <button class="hamburger" onclick="openMobileNav()" aria-label="Men√º">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
    </button>
  </div>
</header>
<main>
  <div id="page-catalog" class="page active">
    <div class="hero">
      <h1>W√ºrdevolle <em>Begleitung</em><br>in schweren Zeiten</h1>
      <div class="gold-line"></div>
      <p>Entdecken Sie unsere Auswahl an hochwertigen Produkten und Dienstleistungen f√ºr eine pers√∂nliche und w√ºrdevolle Abschiednahme.</p>
    </div>
    <div id="categoriesGrid" class="categories-grid"></div>
  </div>
  <div id="page-products" class="page">
    <div class="products-header">
      <button class="back-btn" onclick="navTo('catalog')">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 4l-4 4 4 4"/></svg>Zur√ºck
      </button>
      <h2 id="productsTitle">Kategorie</h2>
    </div>
    <div id="subcategoryBar" class="subcategory-bar"></div>
    <div id="productsGrid" class="products-grid"></div>
  </div>
  <div id="page-about" class="page">
    <div class="hero">
      <h1>√úber <em>Uns</em></h1>
      <div class="gold-line"></div>
      <p>Das Bestattungshaus Kallwa√ü steht seit √ºber 35 Jahren f√ºr einf√ºhlsame und professionelle Begleitung in der Region.</p>
    </div>
    <div style="max-width:640px;margin:0 auto">
      <div style="background:var(--warm-white);border-radius:var(--radius-lg);padding:2rem;border:1px solid rgba(90,26,34,0.06)">
        <h3 style="font-family:var(--font-display);font-size:1.3rem;color:var(--bordeaux);margin-bottom:1rem">Unsere Philosophie</h3>
        <p style="font-size:0.92rem;color:var(--text-muted);line-height:1.8;font-weight:300">Jeder Mensch ist einzigartig ‚Äì und genauso einzigartig sollte auch der letzte Abschied sein. Wir nehmen uns die Zeit, die Sie brauchen, und beraten Sie umfassend zu allen M√∂glichkeiten einer w√ºrdevollen Bestattung.</p>
      </div>
    </div>
  </div>
  <div id="page-admin" class="page">
    <div id="adminLogin">
      <div class="login-card">
        <h2>Verwaltung</h2>
        <p class="subtitle">Melden Sie sich an, um den Katalog zu verwalten</p>
        <div class="form-group"><label>E-Mail</label><input type="email" id="loginEmail" placeholder="admin@bh-kallwass.de" autocomplete="email"></div>
        <div class="form-group"><label>Passwort</label><input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
        <button class="btn btn-primary" onclick="doLogin()" id="loginBtn">Anmelden</button>
      </div>
    </div>
    <div id="adminDashboard" style="display:none">
      <div class="admin-header"><h2>Verwaltung</h2><button class="btn btn-outline btn-sm" onclick="doLogout()">Abmelden</button></div>
      <div class="admin-stats" id="adminStats"></div>
      <div class="admin-tabs">
        <button class="active" onclick="switchAdminTab('categories',this)">Kategorien</button>
        <button onclick="switchAdminTab('products',this)">Produkte</button>
      </div>
      <div id="tab-categories" class="admin-tab-content active">
        <div class="admin-section">
          <h3>Neue Kategorie</h3>
          <div style="display:grid;gap:1rem;grid-template-columns:1fr 1fr">
            <div class="form-group" style="margin:0"><label>Name</label><input type="text" id="catName" placeholder="z.B. S√§rge"></div>
            <div class="form-group" style="margin:0"><label>Beschreibung</label><input type="text" id="catDesc" placeholder="Kurze Beschreibung"></div>
          </div>
          <div class="form-group" style="margin-top:1rem"><label>Symbol (Emoji)</label><input type="text" id="catIcon" placeholder="‚ö±Ô∏è" maxlength="4" style="max-width:80px"></div>
          <div class="toggle-row"><label class="toggle"><input type="checkbox" id="catHasSubcats"><span class="slider"></span></label><label for="catHasSubcats">Unterkategorien aktivieren</label></div>
          <div class="file-upload" style="margin-top:0.5rem">
            <input type="file" accept="image/*" id="catImage" onchange="previewFile(this,'catPreview')">
            <div class="icon">üì∑</div><p>Kategorie-Bild hochladen (optional)</p>
            <img id="catPreview" class="preview-img" style="display:none">
          </div>
          <button class="btn btn-gold" style="margin-top:1rem" onclick="addCategory()">Kategorie hinzuf√ºgen</button>
        </div>
        <div class="admin-section"><h3>Kategorien verwalten</h3><ul class="admin-list" id="adminCatList"></ul></div>
      </div>
      <div id="tab-products" class="admin-tab-content">
        <div class="admin-section">
          <h3>Neues Produkt</h3>
          <div class="form-group"><label>Kategorie</label><select id="prodCat" onchange="onProdCatChange()"></select></div>
          <div class="form-group" id="prodSubcatGroup" style="display:none"><label>Unterkategorie</label><select id="prodSubcat"></select></div>
          <div style="display:grid;gap:1rem;grid-template-columns:1fr 1fr">
            <div class="form-group" style="margin:0"><label>Name</label><input type="text" id="prodName" placeholder="z.B. Eichensarg Classique"></div>
            <div class="form-group" style="margin:0"><label>Preis</label><input type="text" id="prodPrice" placeholder="z.B. ab 1.200 ‚Ç¨"></div>
          </div>
          <div class="form-group"><label>Beschreibung</label><textarea id="prodDesc" placeholder="Produktbeschreibung‚Ä¶"></textarea></div>
          <div class="file-upload">
            <input type="file" accept="image/*" id="prodImage" onchange="previewFile(this,'prodPreview')">
            <div class="icon">üì∑</div><p>Produktbild hochladen</p>
            <img id="prodPreview" class="preview-img" style="display:none">
          </div>
          <button class="btn btn-gold" style="margin-top:1rem" onclick="addProduct()">Produkt hinzuf√ºgen</button>
        </div>
        <div class="admin-section">
          <h3>Produkte</h3>
          <div class="form-group"><label>Filter nach Kategorie</label><select id="prodFilterCat" onchange="renderAdminProducts()"><option value="">Alle</option></select></div>
          <ul class="admin-list" id="adminProdList"></ul>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Product Detail Modal -->
<div class="modal-overlay" id="productModal" onclick="if(event.target===this)closeModal()">
  <div class="modal"><button class="modal-close" onclick="closeModal()">‚úï</button><div class="modal-img" id="modalImg"></div><div class="modal-body"><h2 id="modalTitle"></h2><div class="price" id="modalPrice"></div><div class="desc" id="modalDesc"></div></div></div>
</div>

<!-- Edit Category Modal -->
<div class="edit-modal-overlay" id="editCatModal" onclick="if(event.target===this)closeEditCat()">
  <div class="edit-modal">
    <div class="edit-modal-header"><h3>Kategorie bearbeiten</h3><button class="modal-close" onclick="closeEditCat()" style="position:static;width:32px;height:32px;font-size:1rem;background:var(--warm-gray);color:var(--text-dark)">‚úï</button></div>
    <div class="edit-modal-body">
      <div class="form-group"><label>Name</label><input type="text" id="editCatName"></div>
      <div class="form-group"><label>Beschreibung</label><input type="text" id="editCatDesc"></div>
      <div class="form-group"><label>Symbol (Emoji)</label><input type="text" id="editCatIcon" maxlength="4" style="max-width:80px"></div>
      <div class="toggle-row"><label class="toggle"><input type="checkbox" id="editCatHasSubcats"><span class="slider"></span></label><label for="editCatHasSubcats">Unterkategorien aktivieren</label></div>
      <div class="form-group">
        <label>Bild</label>
        <img id="editCatCurrentImg" class="current-img" style="display:none">
        <div class="file-upload" style="padding:1rem">
          <input type="file" accept="image/*" id="editCatImage" onchange="previewFile(this,'editCatPreview')">
          <p style="font-size:0.82rem">Neues Bild w√§hlen (optional)</p>
          <img id="editCatPreview" class="preview-img" style="display:none">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-outline" onclick="closeEditCat()">Abbrechen</button>
        <button class="btn btn-gold" onclick="saveEditCat()">Speichern</button>
      </div>
    </div>
  </div>
</div>

<div class="zoom-overlay" id="zoomOverlay" onclick="handleZoomClick(event)">
  <button class="zoom-close" onclick="closeZoom(event)">‚úï</button>
  <div class="zoom-container" id="zoomContainer">
    <img id="zoomImg" src="" alt="">
  </div>
  <div class="zoom-hint" id="zoomHint">Doppeltippen oder Pinch zum Zoomen</div>
</div>
<footer><p>&copy; 2026 Bestattungshaus Kallwa√ü ¬∑ <a href="#" onclick="navTo('admin');return false">Verwaltung</a></p></footer>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyDzxxj-kK4eo2RgW-ZQt26cJzHGRs75WbQ",authDomain:"beratungsapp-bh-kallwass.firebaseapp.com",projectId:"beratungsapp-bh-kallwass",storageBucket:"beratungsapp-bh-kallwass.firebasestorage.app",messagingSenderId:"828236712026",appId:"1:828236712026:web:40ed5111d7720d3a10b063"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore(),storage=firebase.storage();
db.enablePersistence({synchronizeTabs:true}).catch(e=>console.log('Persistence:',e.code));

let categories=[],products=[],currentUser=null,currentCategory=null,currentSubcatFilter=null,editingCatId=null;
function saveCache(k,d){try{localStorage.setItem(k,JSON.stringify(d))}catch(e){}}
function loadCache(k){try{return JSON.parse(localStorage.getItem(k))||[]}catch(e){return[]}}

window.addEventListener('DOMContentLoaded',()=>{
  categories=loadCache('bk_cats');products=loadCache('bk_prods');renderCategories();
  db.collection('categories').orderBy('order','asc').onSnapshot(snap=>{
    categories=snap.docs.map(d=>({id:d.id,...d.data()}));
    saveCache('bk_cats',categories);renderCategories();renderAdminCategories();updateCategorySelects();updateStats();
  },e=>console.log('Cat err:',e));
  db.collection('products').orderBy('createdAt','desc').onSnapshot(snap=>{
    products=snap.docs.map(d=>({id:d.id,...d.data()}));
    saveCache('bk_prods',products);if(currentCategory)renderProducts(currentCategory);renderAdminProducts();updateStats();
  },e=>console.log('Prod err:',e));
  auth.onAuthStateChanged(user=>{
    currentUser=user;const li=!!user;
    document.getElementById('adminLogin').style.display=li?'none':'block';
    document.getElementById('adminDashboard').style.display=li?'block':'none';
    const lbl=li?'Verwaltung ‚óè':'Verwaltung';
    const b1=document.getElementById('adminNavBtn'),b2=document.getElementById('adminNavBtnMobile');
    if(b1)b1.textContent=lbl;if(b2)b2.textContent=lbl;
  });
  setTimeout(()=>document.getElementById('loading-screen').classList.add('hidden'),600);
});

/* === NAVIGATION === */
function navTo(pageId){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+pageId).classList.add('active');
  document.querySelectorAll('[data-page]').forEach(b=>b.classList.toggle('active',b.dataset.page===pageId));
  closeMobileNav();window.scrollTo({top:0,behavior:'smooth'});
}
function openMobileNav(){document.getElementById('mobileDrawer').classList.add('open');document.getElementById('mobileOverlay').classList.add('active')}
function closeMobileNav(){document.getElementById('mobileDrawer').classList.remove('open');document.getElementById('mobileOverlay').classList.remove('active')}

/* === RENDER CATEGORIES (PUBLIC) === */
function renderCategories(){
  const grid=document.getElementById('categoriesGrid');
  if(!categories.length){grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="icon">üìã</div><p>Noch keine Kategorien angelegt.<br>Melden Sie sich in der Verwaltung an.</p></div>';return}
  grid.innerHTML=categories.map(cat=>{
    const count=products.filter(p=>p.categoryId===cat.id).length;
    const img=cat.imageUrl?'<img src="'+cat.imageUrl+'" alt="'+esc(cat.name)+'" loading="lazy">':'<span>'+(cat.icon||'üìÅ')+'</span>';
    return '<div class="cat-card" onclick="openCategory(\''+cat.id+'\')"><div class="cat-card-img">'+img+'</div><span class="cat-card-count">'+count+' '+(count===1?'Produkt':'Produkte')+'</span><div class="cat-card-body"><h3>'+esc(cat.name)+'</h3><p>'+esc(cat.description||'')+'</p></div></div>';
  }).join('');
}

/* === OPEN CATEGORY WITH SUBCATEGORY PILLS === */
function openCategory(catId){
  currentCategory=catId;currentSubcatFilter=null;
  const cat=categories.find(c=>c.id===catId);
  document.getElementById('productsTitle').textContent=cat?cat.name:'Produkte';
  const bar=document.getElementById('subcategoryBar');
  if(cat&&cat.subcategories&&cat.subcategories.length>0){
    let html='<button class="subcat-pill all-pill active" onclick="filterSubcat(null,this)">Alle</button>';
    cat.subcategories.forEach(sc=>{
      html+='<button class="subcat-pill" onclick="filterSubcat(\''+esc(sc).replace(/'/g,"\\'")+'\',this)">'+esc(sc)+'</button>';
    });
    bar.innerHTML=html;
    bar.classList.add('visible');
  } else {
    bar.innerHTML='';bar.classList.remove('visible');
  }
  renderProducts(catId);navTo('products');
}

function filterSubcat(subcat,btn){
  currentSubcatFilter=subcat;
  document.querySelectorAll('.subcat-pill').forEach(p=>p.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderProducts(currentCategory);
}

/* === RENDER PRODUCTS (PUBLIC) === */
function renderProducts(catId){
  const grid=document.getElementById('productsGrid');
  let filtered=products.filter(p=>p.categoryId===catId);
  if(currentSubcatFilter)filtered=filtered.filter(p=>p.subcategory===currentSubcatFilter);
  if(!filtered.length){grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="icon">üì¶</div><p>Keine Produkte in dieser Auswahl.</p></div>';return}
  grid.innerHTML=filtered.map((prod,i)=>{
    const img=prod.imageUrl?'<img src="'+prod.imageUrl+'" alt="'+esc(prod.name)+'" loading="lazy">':'';
    return '<div class="product-card" onclick="openProductModal('+i+',\''+catId+'\')"><div class="product-card-img">'+img+'</div><div class="product-card-body"><h4>'+esc(prod.name)+'</h4>'+(prod.price?'<div class="price">'+esc(prod.price)+'</div>':'')+'<div class="desc">'+esc((prod.description||'').substring(0,100))+((prod.description||'').length>100?'‚Ä¶':'')+'</div>'+(prod.subcategory?'<span class="subcat-tag">'+esc(prod.subcategory)+'</span>':'')+'</div></div>';
  }).join('');
}

function openProductModal(idx,catId){
  let filtered=products.filter(p=>p.categoryId===catId);
  if(currentSubcatFilter)filtered=filtered.filter(p=>p.subcategory===currentSubcatFilter);
  const prod=filtered[idx];if(!prod)return;
  document.getElementById('modalImg').innerHTML=prod.imageUrl?'<img src="'+prod.imageUrl+'" alt="'+esc(prod.name)+'" style="cursor:zoom-in">':'';
  var mimg=document.querySelector('#modalImg img');if(mimg){mimg.onclick=function(){openZoom(prod.imageUrl)}};
  document.getElementById('modalTitle').textContent=prod.name;
  document.getElementById('modalPrice').textContent=prod.price||'';
  document.getElementById('modalDesc').textContent=prod.description||'';
  document.getElementById('productModal').classList.add('active');document.body.style.overflow='hidden';
}
function closeModal(){document.getElementById('productModal').classList.remove('active');document.body.style.overflow=''}

/* === AUTH === */
async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim(),pw=document.getElementById('loginPassword').value;
  if(!email||!pw)return toast('Bitte E-Mail und Passwort eingeben','error');
  const btn=document.getElementById('loginBtn');btn.disabled=true;btn.textContent='Wird angemeldet‚Ä¶';
  try{await auth.signInWithEmailAndPassword(email,pw);toast('Erfolgreich angemeldet!','success')}catch(err){toast('Login fehlgeschlagen: '+err.message,'error')}
  btn.disabled=false;btn.textContent='Anmelden';
}
function doLogout(){auth.signOut();toast('Abgemeldet')}

/* === ADMIN: ADD CATEGORY === */
async function addCategory(){
  const name=document.getElementById('catName').value.trim(),desc=document.getElementById('catDesc').value.trim();
  const icon=document.getElementById('catIcon').value.trim(),hasSub=document.getElementById('catHasSubcats').checked;
  const fi=document.getElementById('catImage');
  if(!name)return toast('Bitte Kategorienamen eingeben','error');
  let imageUrl='';if(fi.files[0])imageUrl=await uploadImage(fi.files[0],'categories');
  await db.collection('categories').add({name,description:desc,icon:icon||'üìÅ',imageUrl,hasSubcategories:hasSub,subcategories:[],order:categories.length,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  document.getElementById('catName').value='';document.getElementById('catDesc').value='';document.getElementById('catIcon').value='';document.getElementById('catHasSubcats').checked=false;fi.value='';document.getElementById('catPreview').style.display='none';
  toast('Kategorie hinzugef√ºgt!','success');
}

/* === ADMIN: DELETE CATEGORY === */
async function deleteCategory(id){if(!confirm('Kategorie wirklich l√∂schen?'))return;await db.collection('categories').doc(id).delete();toast('Kategorie gel√∂scht')}

/* === ADMIN: MOVE CATEGORY UP/DOWN === */
async function moveCategory(id,direction){
  const idx=categories.findIndex(c=>c.id===id);
  const swapIdx=idx+direction;
  if(swapIdx<0||swapIdx>=categories.length)return;
  const batch=db.batch();
  batch.update(db.collection('categories').doc(categories[idx].id),{order:swapIdx});
  batch.update(db.collection('categories').doc(categories[swapIdx].id),{order:idx});
  await batch.commit();
}

/* === ADMIN: EDIT CATEGORY MODAL === */
function openEditCat(id){
  const cat=categories.find(c=>c.id===id);if(!cat)return;
  editingCatId=id;
  document.getElementById('editCatName').value=cat.name||'';
  document.getElementById('editCatDesc').value=cat.description||'';
  document.getElementById('editCatIcon').value=cat.icon||'';
  document.getElementById('editCatHasSubcats').checked=!!cat.hasSubcategories;
  const curImg=document.getElementById('editCatCurrentImg');
  if(cat.imageUrl){curImg.src=cat.imageUrl;curImg.style.display='block'}else{curImg.style.display='none'}
  document.getElementById('editCatImage').value='';
  document.getElementById('editCatPreview').style.display='none';
  document.getElementById('editCatModal').classList.add('active');document.body.style.overflow='hidden';
}
function closeEditCat(){
  document.getElementById('editCatModal').classList.remove('active');document.body.style.overflow='';editingCatId=null;
}
async function saveEditCat(){
  if(!editingCatId)return;
  const name=document.getElementById('editCatName').value.trim();
  if(!name)return toast('Name darf nicht leer sein','error');
  const updates={
    name,
    description:document.getElementById('editCatDesc').value.trim(),
    icon:document.getElementById('editCatIcon').value.trim()||'üìÅ',
    hasSubcategories:document.getElementById('editCatHasSubcats').checked
  };
  const fi=document.getElementById('editCatImage');
  if(fi.files[0]){updates.imageUrl=await uploadImage(fi.files[0],'categories')}
  await db.collection('categories').doc(editingCatId).update(updates);
  closeEditCat();toast('Kategorie aktualisiert!','success');
}

/* === ADMIN: SUBCATEGORIES === */
async function addSubcategory(catId){
  const input=document.getElementById('subcat-input-'+catId);const name=input.value.trim();if(!name)return;
  const cat=categories.find(c=>c.id===catId);const subs=[...(cat.subcategories||[])];
  if(subs.includes(name))return toast('Existiert bereits','error');
  subs.push(name);await db.collection('categories').doc(catId).update({subcategories:subs});
  input.value='';toast('Unterkategorie hinzugef√ºgt!','success');
}
async function removeSubcategory(catId,subName){
  if(!confirm('"'+subName+'" entfernen?'))return;
  const cat=categories.find(c=>c.id===catId);
  const subs=(cat.subcategories||[]).filter(s=>s!==subName);
  await db.collection('categories').doc(catId).update({subcategories:subs});toast('Unterkategorie entfernt');
}

/* === RENDER ADMIN CATEGORIES === */
function renderAdminCategories(){
  const list=document.getElementById('adminCatList');if(!list)return;
  if(!categories.length){list.innerHTML='<li style="text-align:center;color:var(--text-muted);font-size:0.9rem;display:block;padding:1.5rem">Noch keine Kategorien</li>';return}
  list.innerHTML=categories.map((cat,idx)=>{
    const pc=products.filter(p=>p.categoryId===cat.id).length;
    const isFirst=idx===0,isLast=idx===categories.length-1;
    const subcatsHtml=cat.hasSubcategories?
      '<ul class="subcat-list">'+(cat.subcategories||[]).map(sc=>'<li><span style="color:var(--text-muted)">‚Ü≥ '+esc(sc)+'</span><button style="background:none;border:none;color:#c0392b;cursor:pointer;font-size:0.8rem;margin-left:0.5rem" onclick="removeSubcategory(\''+cat.id+'\',\''+esc(sc).replace(/'/g,"\\'")+'\')">‚úï</button></li>').join('')+'</ul><div class="subcat-inline"><input type="text" id="subcat-input-'+cat.id+'" placeholder="Neue Unterkategorie‚Ä¶" onkeydown="if(event.key===\'Enter\')addSubcategory(\''+cat.id+'\')"><button onclick="addSubcategory(\''+cat.id+'\')">+ Hinzuf√ºgen</button></div>':'';
    return '<li style="flex-direction:column;align-items:stretch;display:flex"><div class="cat-row"><div class="item-info">'+(cat.imageUrl?'<img class="item-thumb" src="'+cat.imageUrl+'">':'<div class="item-thumb" style="display:flex;align-items:center;justify-content:center;font-size:1.4rem">'+(cat.icon||'üìÅ')+'</div>')+'<div><div class="item-name">'+esc(cat.name)+'</div><div style="font-size:0.75rem;color:var(--text-light)">'+pc+' Produkte'+(cat.hasSubcategories?' ¬∑ '+((cat.subcategories||[]).length)+' Unterkategorien':'')+'</div></div></div><div class="item-actions"><button onclick="moveCategory(\''+cat.id+'\',-1)" title="Nach oben"'+(isFirst?' disabled':'')+'>‚ñ≤</button><button onclick="moveCategory(\''+cat.id+'\',1)" title="Nach unten"'+(isLast?' disabled':'')+'>‚ñº</button><button onclick="openEditCat(\''+cat.id+'\')" title="Bearbeiten">‚úèÔ∏è</button><button class="del" onclick="deleteCategory(\''+cat.id+'\')" title="L√∂schen">üóë</button></div></div>'+subcatsHtml+'</li>';
  }).join('');
}

/* === ADMIN: PRODUCTS === */
function onProdCatChange(){
  const catId=document.getElementById('prodCat').value;
  const cat=categories.find(c=>c.id===catId);
  const group=document.getElementById('prodSubcatGroup'),sel=document.getElementById('prodSubcat');
  if(cat&&cat.hasSubcategories&&cat.subcategories&&cat.subcategories.length>0){
    sel.innerHTML='<option value="">Keine Unterkategorie</option>'+cat.subcategories.map(sc=>'<option value="'+esc(sc)+'">'+esc(sc)+'</option>').join('');
    group.style.display='block';
  }else{group.style.display='none';sel.innerHTML=''}
}
async function addProduct(){
  const catId=document.getElementById('prodCat').value,name=document.getElementById('prodName').value.trim();
  const price=document.getElementById('prodPrice').value.trim(),desc=document.getElementById('prodDesc').value.trim();
  const subcat=document.getElementById('prodSubcat').value||null,fi=document.getElementById('prodImage');
  if(!catId)return toast('Bitte Kategorie w√§hlen','error');if(!name)return toast('Bitte Produktnamen eingeben','error');
  let imageUrl='';if(fi.files[0])imageUrl=await uploadImage(fi.files[0],'products');
  const data={categoryId:catId,name,price,description:desc,imageUrl,createdAt:firebase.firestore.FieldValue.serverTimestamp()};
  if(subcat)data.subcategory=subcat;
  await db.collection('products').add(data);
  document.getElementById('prodName').value='';document.getElementById('prodPrice').value='';document.getElementById('prodDesc').value='';fi.value='';document.getElementById('prodPreview').style.display='none';
  toast('Produkt hinzugef√ºgt!','success');
}
async function deleteProduct(id){if(!confirm('Produkt wirklich l√∂schen?'))return;await db.collection('products').doc(id).delete();toast('Produkt gel√∂scht')}
function renderAdminProducts(){
  const list=document.getElementById('adminProdList');if(!list)return;
  const fc=document.getElementById('prodFilterCat')?.value||'';
  const filtered=fc?products.filter(p=>p.categoryId===fc):products;
  if(!filtered.length){list.innerHTML='<li style="text-align:center;color:var(--text-muted);font-size:0.9rem;display:block;padding:1rem">Keine Produkte</li>';return}
  list.innerHTML=filtered.map(prod=>{
    const cat=categories.find(c=>c.id===prod.categoryId);
    return '<li><div class="item-info">'+(prod.imageUrl?'<img class="item-thumb" src="'+prod.imageUrl+'">':'<div class="item-thumb"></div>')+'<div><div class="item-name">'+esc(prod.name)+'</div><div style="font-size:0.75rem;color:var(--text-light)">'+(cat?cat.name:'‚Äì')+(prod.subcategory?' ¬∑ '+prod.subcategory:'')+' '+(prod.price?'¬∑ '+prod.price:'')+'</div></div></div><div class="item-actions"><button class="del" onclick="deleteProduct(\''+prod.id+'\')" title="L√∂schen">üóë</button></div></li>';
  }).join('');
}

/* === HELPERS === */
function updateCategorySelects(){
  ['prodCat','prodFilterCat'].forEach(id=>{const sel=document.getElementById(id);if(!sel)return;const val=sel.value;const isF=id==='prodFilterCat';sel.innerHTML=(isF?'<option value="">Alle</option>':'<option value="">Kategorie w√§hlen‚Ä¶</option>')+categories.map(c=>'<option value="'+c.id+'">'+esc(c.name)+'</option>').join('');sel.value=val});
}
function switchAdminTab(tab,btn){
  document.querySelectorAll('.admin-tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.admin-tabs button').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');btn.classList.add('active');
}
function updateStats(){
  const el=document.getElementById('adminStats');if(!el)return;
  const sc=categories.reduce((n,c)=>n+(c.subcategories?c.subcategories.length:0),0);
  el.innerHTML='<div class="stat-card"><div class="num">'+categories.length+'</div><div class="label">Kategorien</div></div><div class="stat-card"><div class="num">'+sc+'</div><div class="label">Unterkategorien</div></div><div class="stat-card"><div class="num">'+products.length+'</div><div class="label">Produkte</div></div><div class="stat-card"><div class="num">'+products.filter(p=>p.imageUrl).length+'</div><div class="label">Mit Bild</div></div>';
}
async function uploadImage(file,folder){
  const ts=Date.now(),ext=file.name.split('.').pop();
  const ref=storage.ref(folder+'/'+ts+'.'+ext);
  let f=file;if(file.size>1024*1024)f=await compressImage(file,0.7,1200);
  const snap=await ref.put(f);return await snap.ref.getDownloadURL();
}
function compressImage(file,quality,maxW){
  return new Promise(resolve=>{const reader=new FileReader();reader.onload=e=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas');let w=img.width,h=img.height;if(w>maxW){h=h*maxW/w;w=maxW}c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);c.toBlob(resolve,'image/jpeg',quality)};img.src=e.target.result};reader.readAsDataURL(file)});
}
function previewFile(input,id){const p=document.getElementById(id);if(input.files[0]){const r=new FileReader();r.onload=e=>{p.src=e.target.result;p.style.display='block'};r.readAsDataURL(input.files[0])}else p.style.display='none'}
function toast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type;setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>t.classList.remove('show'),3000)}
function esc(str){const d=document.createElement('div');d.textContent=str||'';return d.innerHTML}
/* === ZOOM VIEWER === */
let zoomLevel=1,zoomPosX=0,zoomPosY=0,isDragging=false,dragStartX=0,dragStartY=0,lastTap=0;
function openZoom(imgSrc){
  if(!imgSrc)return;
  const ov=document.getElementById('zoomOverlay');
  document.getElementById('zoomImg').src=imgSrc;
  zoomLevel=1;zoomPosX=0;zoomPosY=0;updateZoomTransform();
  ov.classList.add('active');document.body.style.overflow='hidden';
  document.getElementById('zoomContainer').classList.remove('zoomed');
  const hint=document.getElementById('zoomHint');hint.style.opacity='1';
  setTimeout(function(){hint.style.opacity='0'},2500);
}
function closeZoom(e){
  if(e)e.stopPropagation();
  document.getElementById('zoomOverlay').classList.remove('active');
  document.body.style.overflow='';zoomLevel=1;zoomPosX=0;zoomPosY=0;
}
function handleZoomClick(e){
  var t=e.target;
  if(t.id==='zoomOverlay'||t.id==='zoomContainer'){
    if(zoomLevel>1){zoomLevel=1;zoomPosX=0;zoomPosY=0;updateZoomTransform();document.getElementById('zoomContainer').classList.remove('zoomed')}
    else closeZoom();
  }
}
function updateZoomTransform(){
  document.getElementById('zoomImg').style.transform='scale('+zoomLevel+') translate('+zoomPosX+'px,'+zoomPosY+'px)';
}
(function initZoom(){
  setTimeout(function(){
    var c=document.getElementById('zoomContainer');if(!c)return;
    c.addEventListener('dblclick',function(e){
      e.preventDefault();
      if(zoomLevel>1){zoomLevel=1;zoomPosX=0;zoomPosY=0;c.classList.remove('zoomed')}
      else{zoomLevel=2.5;c.classList.add('zoomed')}
      updateZoomTransform();
    });
    c.addEventListener('touchstart',function(e){
      if(e.touches.length===1){
        var now=Date.now();
        if(now-lastTap<300){e.preventDefault();
          if(zoomLevel>1){zoomLevel=1;zoomPosX=0;zoomPosY=0;c.classList.remove('zoomed')}
          else{zoomLevel=2.5;c.classList.add('zoomed')}
          updateZoomTransform();
        }
        lastTap=now;
        if(zoomLevel>1){isDragging=true;dragStartX=e.touches[0].clientX-zoomPosX*zoomLevel;dragStartY=e.touches[0].clientY-zoomPosY*zoomLevel}
      }
      if(e.touches.length===2){e.preventDefault();c._pinchStart=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);c._pinchZoom=zoomLevel}
    },{passive:false});
    c.addEventListener('touchmove',function(e){
      if(e.touches.length===2&&c._pinchStart){e.preventDefault();
        var dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
        zoomLevel=Math.min(5,Math.max(1,c._pinchZoom*(dist/c._pinchStart)));
        if(zoomLevel<=1){zoomPosX=0;zoomPosY=0;c.classList.remove('zoomed')}else{c.classList.add('zoomed')}
        updateZoomTransform();
      }else if(e.touches.length===1&&isDragging&&zoomLevel>1){e.preventDefault();
        zoomPosX=(e.touches[0].clientX-dragStartX)/zoomLevel;zoomPosY=(e.touches[0].clientY-dragStartY)/zoomLevel;
        updateZoomTransform();
      }
    },{passive:false});
    c.addEventListener('touchend',function(e){
      isDragging=false;if(e.touches.length<2)c._pinchStart=null;
      if(zoomLevel<=1.05){zoomLevel=1;zoomPosX=0;zoomPosY=0;c.classList.remove('zoomed');updateZoomTransform()}
    });
    c.addEventListener('wheel',function(e){e.preventDefault();
      zoomLevel=Math.min(5,Math.max(1,zoomLevel*(e.deltaY>0?0.8:1.25)));
      if(zoomLevel<=1){zoomPosX=0;zoomPosY=0;c.classList.remove('zoomed')}else{c.classList.add('zoomed')}
      updateZoomTransform();
    },{passive:false});
  },500);
})();
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeZoom();closeModal();closeEditCat();closeMobileNav()}if(e.key==='Enter'&&document.activeElement?.id==='loginPassword')doLogin()});
</script>
</body>
</html>
